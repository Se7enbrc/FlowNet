#!/bin/bash
#
# flowctl - FlowNet daemon control utility
#

set -e

# Auto-detect Homebrew prefix (Apple Silicon vs Intel)
if [ -x "/opt/homebrew/bin/flownet" ]; then
    DAEMON_BIN="/opt/homebrew/bin/flownet"
elif [ -x "/usr/local/bin/flownet" ]; then
    DAEMON_BIN="/usr/local/bin/flownet"
else
    DAEMON_BIN="/usr/local/bin/flownet"  # Default for manual installs
fi

PLIST_PATH="/Library/LaunchDaemons/com.whaleyshire.flownet.plist"
LOG_PATH="/var/log/flownet.log"
LABEL="com.whaleyshire.flownet"

cmd_status() {
    echo "FlowNet Status:"
    echo ""

    # Check AWDL status (most important)
    if ifconfig awdl0 2>/dev/null | grep -q "UP"; then
        echo "  ⚠️  AWDL is UP"
    else
        echo "  ✓ AWDL is DOWN"
    fi

    # Check if service is loaded
    if launchctl print system/$LABEL &>/dev/null || sudo launchctl print system/$LABEL &>/dev/null; then
        echo "  ✓ Service running"
    else
        echo "  ✗ Service NOT running"
        echo ""
        echo "Start with: sudo brew services start flownet"
    fi

    # Check logs
    if [ -f "$LOG_PATH" ]; then
        LINES=$(wc -l < "$LOG_PATH" 2>/dev/null || echo "?")
        LAST_LINE=$(tail -1 "$LOG_PATH" 2>/dev/null)
        echo "  ✓ Logs: $LOG_PATH"
        if [ -n "$LAST_LINE" ]; then
            echo "    Last: $LAST_LINE"
        fi
    fi
}

cmd_start() {
    if ! sudo launchctl list | grep -q "$LABEL"; then
        echo "Starting FlowNet daemon..."
        sudo launchctl bootstrap system "$PLIST_PATH"
        sudo launchctl kickstart system/$LABEL
        echo "✓ Started"
    else
        echo "✓ Already running"
        sudo launchctl kickstart -k system/$LABEL
        echo "✓ Restarted"
    fi
}

cmd_stop() {
    if sudo launchctl list | grep -q "$LABEL"; then
        echo "Stopping FlowNet daemon..."
        sudo launchctl bootout system/$LABEL
        echo "✓ Stopped"
    else
        echo "✓ Already stopped"
    fi
}

cmd_restart() {
    cmd_stop
    sleep 1
    cmd_start
}

cmd_logs() {
    if [ -f "$LOG_PATH" ]; then
        tail -f "$LOG_PATH"
    else
        echo "No logs found at $LOG_PATH"
        exit 1
    fi
}

cmd_install() {
    echo "Installing FlowNet daemon..."

    # Check if running from build directory
    if [ ! -f "build/flownet" ]; then
        echo "Error: Run 'make' first"
        exit 1
    fi

    # Install flowctl itself to /usr/local/bin
    sudo cp flowctl /usr/local/bin/flowctl
    sudo chmod 755 /usr/local/bin/flowctl
    echo "  ✓ flowctl installed to /usr/local/bin"

    # Copy daemon binary
    sudo cp build/flownet "$DAEMON_BIN"
    sudo chmod 755 "$DAEMON_BIN"
    sudo chown root:wheel "$DAEMON_BIN"
    echo "  ✓ Daemon binary installed to $DAEMON_BIN"

    # Generate plist with correct daemon path
    cat > /tmp/flownet.plist << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.whaleyshire.flownet</string>
    <key>ProgramArguments</key>
    <array>
        <string>$DAEMON_BIN</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <dict>
        <key>SuccessfulExit</key>
        <false/>
    </dict>
    <key>ThrottleInterval</key>
    <integer>30</integer>
    <key>StandardOutPath</key>
    <string>$LOG_PATH</string>
    <key>StandardErrorPath</key>
    <string>$LOG_PATH</string>
    <key>UserName</key>
    <string>root</string>
    <key>ProcessType</key>
    <string>Background</string>
    <key>Nice</key>
    <integer>1</integer>
    <key>AbandonProcessGroup</key>
    <true/>
</dict>
</plist>
EOF

    sudo mv /tmp/flownet.plist "$PLIST_PATH"
    sudo chmod 644 "$PLIST_PATH"
    sudo chown root:wheel "$PLIST_PATH"
    echo "  ✓ LaunchDaemon configured"

    # Create log file
    sudo touch "$LOG_PATH"
    sudo chmod 644 "$LOG_PATH"
    echo "  ✓ Log file created"

    # Start service
    cmd_start

    echo ""
    echo "✓ FlowNet installed and running"
    echo ""
    echo "flowctl is now in your PATH. Run 'flowctl status' from anywhere."
}

cmd_uninstall() {
    echo "Uninstalling FlowNet daemon..."

    # Stop service
    cmd_stop 2>/dev/null || true

    # Remove files
    sudo rm -f "$DAEMON_BIN"
    sudo rm -f "$PLIST_PATH"
    sudo rm -f /usr/local/bin/flowctl
    echo "  ✓ Files removed"

    # Ask about logs
    if [ -f "$LOG_PATH" ]; then
        read -p "Remove logs? (y/N) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            sudo rm -f "$LOG_PATH"
            echo "  ✓ Logs removed"
        fi
    fi

    echo "✓ FlowNet uninstalled"
    echo ""
    echo "To reinstall:"
    echo "  brew install --cask Se7enbrc/flownet/flownet"
    echo ""
    echo "Or build from source:"
    echo "  git clone https://github.com/Se7enbrc/flownet.git"
    echo "  cd flownet && make && sudo ./flowctl install"
}

cmd_help() {
    cat << 'EOF'
flowctl - FlowNet daemon control utility

Usage: flowctl <command>

Commands:
  status      Show daemon status and AWDL state
  start       Start the daemon
  stop        Stop the daemon
  restart     Restart the daemon
  logs        Tail the daemon logs (Ctrl+C to exit)
  install     Install daemon and start service
  uninstall   Remove daemon and stop service

Examples:
  flowctl status
  flowctl start
  flowctl logs
EOF
}

# Main
case "${1:-}" in
    status)
        cmd_status
        ;;
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    restart)
        cmd_restart
        ;;
    logs)
        cmd_logs
        ;;
    install)
        cmd_install
        ;;
    uninstall)
        cmd_uninstall
        ;;
    help|--help|-h|"")
        cmd_help
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'flowctl help' for usage"
        exit 1
        ;;
esac
